<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOON Weekly Test Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --yoon-red: #D6001C;
            --yoon-black: #222222;
            --yoon-gray: #F4F4F4;
            --footer-bg: #1a1a1a;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--yoon-gray);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .main-wrapper {
            flex: 1;
            width: 100%;
            max-width: 850px;
            margin: 40px auto;
            padding: 0 20px;
            box-sizing: border-box;
        }

        .card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            padding: 40px;
            border-top: 6px solid var(--yoon-red);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .brand-title {
            color: var(--yoon-red);
            font-size: 2.5rem;
            font-weight: 900;
            margin: 0;
            letter-spacing: -1px;
        }
        .brand-subtitle {
            color: #666;
            font-size: 1.1rem;
            margin-top: 5px;
            font-weight: 500;
        }

        /* í•™ìƒ ì •ë³´ ì…ë ¥ ì„¹ì…˜ */
        .info-section {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .input-group {
            flex: 1;
            max-width: 200px;
        }
        .input-label {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--yoon-black);
            margin-bottom: 5px;
            display: block;
            text-align: center; /* [ìš”ì²­ë°˜ì˜] ë¼ë²¨ ê°€ìš´ë° ì •ë ¬ */
        }
        .text-input {
            width: 100%;
            padding: 10px 15px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            outline: none;
            box-sizing: border-box;
            transition: border 0.2s;
            text-align: center; /* ì…ë ¥ í…ìŠ¤íŠ¸ë„ ê°€ìš´ë° ì •ë ¬í•˜ë©´ ë” ì˜ˆì©ë‹ˆë‹¤ */
        }
        .text-input:focus {
            border-color: var(--yoon-red);
            box-shadow: 0 0 0 2px rgba(214, 0, 28, 0.1);
        }

        /* êµì¬ ì„ íƒ ì„¹ì…˜ */
        .book-section {
            background-color: #FFF5F5;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            margin-bottom: 30px;
            border: 1px solid #FFD1D1;
        }
        
        .book-label {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--yoon-black);
            margin-bottom: 10px;
            display: block;
        }

        select {
            width: 100%;
            max-width: 400px;
            padding: 12px 15px;
            font-size: 1rem;
            border: 2px solid var(--yoon-red);
            border-radius: 8px;
            outline: none;
            background: white;
            cursor: pointer;
            font-family: inherit;
        }

        .pattern-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 12px;
            margin-bottom: 30px;
            max-height: 500px;
            overflow-y: auto;
            padding: 5px;
        }
        .pattern-list::-webkit-scrollbar { width: 8px; }
        .pattern-list::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 4px; }

        .pattern-item {
            background: white;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            position: relative;
        }
        .pattern-item:hover {
            border-color: var(--yoon-red);
            background-color: #FFF9F9;
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        .pattern-item.selected {
            background-color: #FFEEEE;
            border-color: var(--yoon-red);
            box-shadow: 0 0 0 1px var(--yoon-red);
        }
        .pattern-badge {
            background-color: var(--yoon-red);
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 8px;
        }
        .pattern-text {
            font-size: 0.95rem;
            color: #333;
            font-weight: 500;
        }

        .bottom-area {
            text-align: center;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .count-info {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.95rem;
        }
        .count-num {
            color: var(--yoon-red);
            font-weight: bold;
            font-size: 1.2rem;
        }

        .generate-btn {
            background-color: var(--yoon-red);
            color: white;
            border: none;
            padding: 16px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 4px 15px rgba(214, 0, 28, 0.3);
            width: 100%;
            max-width: 300px;
        }
        .generate-btn:hover:not(:disabled) {
            background-color: #b00017;
            transform: translateY(-2px);
        }
        .generate-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        .footer {
            background-color: var(--footer-bg);
            color: #888;
            padding: 20px;
            text-align: center;
            font-size: 0.8rem;
            margin-top: auto;
        }
        .footer-copy {
            font-family: 'Arial', sans-serif;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>

    <div class="main-wrapper">
        <div class="card">
            <div class="header">
                <h1 class="brand-title">Yoon's Weekly Pattern UP!</h1>
                <div class="brand-subtitle">ì›Œí¬ì‹œíŠ¸ ìë™ ìƒì„±ê¸°</div>
            </div>

            <div class="info-section">
                <div class="input-group">
                    <label class="input-label">ì´ë¦„ (Name)</label>
                    <input type="text" id="studentName" class="text-input" placeholder="ì´ë¦„ ì…ë ¥">
                </div>
                <div class="input-group">
                    <label class="input-label">ë‚ ì§œ (Date)</label>
                    <input type="text" id="studentDate" class="text-input" placeholder="ì˜ˆ: 11/25">
                </div>
            </div>

            <div class="book-section">
                <label class="book-label">ğŸ“š êµì¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</label>
                <select id="bookSelect" onchange="loadPatterns()">
                    <option value="" disabled selected>ëª©ë¡ì—ì„œ êµì¬ ì„ íƒ</option>
                    {% if books %}
                        {% for book in books %}
                        <option value="{{ book }}">{{ book.replace('.xlsx', '') }}</option>
                        {% endfor %}
                    {% else %}
                        <option value="" disabled>ë“±ë¡ëœ êµì¬ê°€ ì—†ìŠµë‹ˆë‹¤ (databases í´ë” í™•ì¸)</option>
                    {% endif %}
                </select>
            </div>

            <div id="loadingMsg" style="text-align:center; display:none; color:#888; margin: 20px;">
                íŒ¨í„´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
            </div>

            <div class="pattern-list" id="patternList">
                <div style="text-align:center; padding:40px; color:#999; grid-column: 1/-1;">
                    ìœ„ì—ì„œ êµì¬ë¥¼ ì„ íƒí•˜ë©´ íŒ¨í„´ ëª©ë¡ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.
                </div>
            </div>

            <div class="bottom-area">
                <div class="count-info">
                    ì„ íƒëœ íŒ¨í„´: <span id="selectedCount" class="count-num">0</span> / 5
                </div>
                <button onclick="generatePDF()" class="generate-btn" id="genBtn" disabled>
                    ì›Œí¬ì‹œíŠ¸ ìƒì„± ë° ë¯¸ë¦¬ë³´ê¸°
                </button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-copy">
            Copyright Â© YOON ENGLISH SCHOOL. All Rights Reserved.
        </div>
    </footer>

    <script>
        let selectedPatterns = new Set();
        let currentBook = "";

        async function loadPatterns() {
            const bookSelect = document.getElementById('bookSelect');
            const filename = bookSelect.value;
            const listDiv = document.getElementById('patternList');
            const loadingMsg = document.getElementById('loadingMsg');
            
            if (!filename) return;

            currentBook = filename;
            selectedPatterns.clear();
            updateUI();
            
            listDiv.innerHTML = '';
            loadingMsg.style.display = 'block';

            try {
                const res = await fetch(`/get_patterns/${filename}`);
                const data = await res.json();
                
                loadingMsg.style.display = 'none';
                
                if (data.success) {
                    if (data.patterns.length === 0) {
                        listDiv.innerHTML = '<div style="text-align:center; padding:20px; grid-column:1/-1;">ì´ êµì¬ì—ëŠ” íŒ¨í„´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    data.patterns.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'pattern-item';
                        div.onclick = () => togglePattern(div, p.number);
                        
                        div.innerHTML = `
                            <span class="pattern-badge">P.${p.number}</span>
                            <span class="pattern-text">${p.name}</span>
                            <input type="checkbox" style="display:none;"> 
                        `;
                        listDiv.appendChild(div);
                    });
                } else {
                    listDiv.innerHTML = `<div style="color:red; text-align:center;">ì˜¤ë¥˜ ë°œìƒ: ${data.error}</div>`;
                }
            } catch (e) {
                loadingMsg.style.display = 'none';
                listDiv.innerHTML = '<div style="color:red; text-align:center;">ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        function togglePattern(element, num) {
            const strNum = String(num);
            const checkbox = element.querySelector('input');

            if (selectedPatterns.has(strNum)) {
                selectedPatterns.delete(strNum);
                element.classList.remove('selected');
                if(checkbox) checkbox.checked = false;
            } else {
                if (selectedPatterns.size >= 5) {
                    alert('íŒ¨í„´ì€ ìµœëŒ€ 5ê°œê¹Œì§€ë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }
                selectedPatterns.add(strNum);
                element.classList.add('selected');
                if(checkbox) checkbox.checked = true;
            }
            updateUI();
        }

        function updateUI() {
            const count = selectedPatterns.size;
            document.getElementById('selectedCount').innerText = count;
            const btn = document.getElementById('genBtn');
            
            if (count > 0) {
                btn.disabled = false;
                btn.innerText = "ì›Œí¬ì‹œíŠ¸ ìƒì„± ë° ë¯¸ë¦¬ë³´ê¸°";
            } else {
                btn.disabled = true;
                btn.innerText = "íŒ¨í„´ì„ ì„ íƒí•´ì£¼ì„¸ìš”";
            }
        }

        async function generatePDF() {
            const btn = document.getElementById('genBtn');
            
            // [ìˆ˜ì •ë¨] í•™ë…„ ëŒ€ì‹  ë‚ ì§œ ê°’ ê°€ì ¸ì˜¤ê¸°
            const studentName = document.getElementById('studentName').value;
            const studentDate = document.getElementById('studentDate').value;

            btn.disabled = true;
            btn.innerText = 'ìƒì„± ì¤‘... â³';

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        book: currentBook,
                        patterns: Array.from(selectedPatterns),
                        name: studentName,
                        date: studentDate // [ìˆ˜ì •ë¨] date ì „ì†¡
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    window.open(url, '_blank');
                    btn.innerText = 'ìƒì„± ì™„ë£Œ! (ìƒˆ íƒ­ í™•ì¸) âœ…';
                } else {
                    const err = await response.json();
                    alert('ì˜¤ë¥˜: ' + err.error);
                    btn.innerText = 'ì›Œí¬ì‹œíŠ¸ ìƒì„± ë° ë¯¸ë¦¬ë³´ê¸°';
                }
            } catch (e) {
                alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                btn.innerText = 'ì›Œí¬ì‹œíŠ¸ ìƒì„± ë° ë¯¸ë¦¬ë³´ê¸°';
            } finally {
                setTimeout(() => {
                    if(selectedPatterns.size > 0) {
                        btn.disabled = false;
                        btn.innerText = 'ì›Œí¬ì‹œíŠ¸ ìƒì„± ë° ë¯¸ë¦¬ë³´ê¸°';
                    }
                }, 2000);
            }
        }
    </script>
</body>
</html>